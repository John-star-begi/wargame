<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Executives War Game — Class A Fix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel (JSX in-browser) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Recharts (UMD) -->
  <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.min.js"></script>

  <style>
    :root{
      --c-bg:#F9FBFC;
      --c-primary:#76CAE3;   /* sky blue */
      --c-navy:#1E3A8A;      /* navy */
      --c-lav:#D9E7F1;       /* lavender */
      --c-mint:#42B77E;      /* success */
      --c-amber:#FFB84D;     /* warning */
      --c-coral:#E84855;     /* error */
      --c-text:#0f172a;      /* slate-900-ish */
      --radius:14px;
      --shadow:0 2px 6px rgba(0,0,0,.05);
      --shadow-hover:0 6px 18px rgba(0,0,0,.08);
      --gutter:24px;
      --transition:150ms cubic-bezier(.2,.7,.2,1);
    }
    html,body{height:100%;}
    body{
      background:var(--c-bg);
      color:var(--c-text);
      font-family: "Roboto", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    }
    .wrap{ padding:16px; }
    @media(min-width:768px){ .wrap{ padding:var(--gutter); } }
    .ui-card{
      background:#fff;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      transition:transform var(--transition), box-shadow var(--transition), background var(--transition);
    }
    .ui-card:hover{ box-shadow:var(--shadow-hover); }
    .ui-title{ font-weight:700; font-size:22px; color:var(--c-navy); }
    .ui-sub{ font-weight:500; font-size:16px; color:#475569; }
    .ui-body{ font-weight:400; font-size:14px; }
    .btn{ border:none; border-radius:12px; padding:.6rem 1rem; font-weight:700; transition:transform var(--transition), background var(--transition); }
    .btn:hover{ transform:scale(1.02); }
    .btn-primary{ background:var(--c-primary); color:#083344; }
    .badge{ display:inline-flex; align-items:center; padding:.18rem .55rem; border-radius:999px; font-size:12px; font-weight:700; }
    .badge-info{ background:rgba(118,202,227,.15); color:#0b2e57; }
    .badge-success{ background:rgba(66,183,126,.12); color:#1c7a55; }
    .chart-h { height: 320px; }
    .tabs{ display:flex; gap:.5rem; flex-wrap:wrap; }
    .tab-btn{ padding:.5rem .8rem; border-radius:10px; background:#fff; border:1px solid #e5e7eb; color:#0b2e57; font-weight:700; }
    .tab-btn.active{ background:var(--c-navy); color:#fff; }
    .ui-label{ font-size:12px; color:#64748b; display:block; margin-bottom:.25rem; }
    .ui-input{
      width:100%; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:.55rem .75rem;
      outline:none; transition: box-shadow var(--transition), border-color var(--transition);
    }
    .ui-input:focus{ border-color: var(--c-primary); box-shadow: 0 0 0 3px rgba(118,202,227,.25); }
    .grid-cards{ display:grid; gap:16px; }
    @media(min-width:768px){ .grid-cards{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
    @media(min-width:1024px){ .grid-cards{ grid-template-columns:repeat(4,minmax(0,1fr)); } }
  </style>
</head>
<body>
  <div id="root" class="wrap max-w-[1200px] mx-auto"></div>

  <!-- APP -->
  <script type="text/babel" data-presets="react">
    // Pull Recharts safely from the UMD global
    const RC = window.Recharts;
    const {
      LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer,
      CartesianGrid, Legend, BarChart, Bar, AreaChart, Area
    } = RC;

    const { useMemo, useState, useEffect } = React;

    // ————— Utilities —————
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const fmtMoney = (n)=> (isFinite(n)? n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}) : '—');
    const fmtInt   = (n)=> (isFinite(n)? Math.round(n).toLocaleString() : '—');
    const clamp    = (v,min,max)=> Math.max(min, Math.min(max, v));

    function NumberInput({label, value, onChange, step=1, min=0, max=1e12, hint}) {
      // fully free numeric entry; arrows optional
      const handle = (e)=>{
        const raw = e.target.value.replace(/[^\d.\-]/g,'');
        if(raw===''){ onChange(0); return; }
        let n = Number(raw);
        if(!isFinite(n)) n = 0;
        onChange(clamp(n, min, max));
      };
      return (
        <div>
          <label className="ui-label">{label}</label>
          <input className="ui-input" type="text" value={String(value)} onChange={handle} placeholder="Enter number..." />
          {hint && <div className="text-[12px] text-slate-500 mt-1">{hint}</div>}
        </div>
      );
    }
    function PercentInput({label, value, onChange, step=0.01, min=0, max=1}) {
      const handle = (e)=>{
        const raw = e.target.value.replace(/[^\d.\-]/g,'');
        if(raw===''){ onChange(0); return; }
        let n = Number(raw)/100;
        if(!isFinite(n)) n = 0;
        onChange(clamp(n, min, max));
      };
      return (
        <div>
          <label className="ui-label">{label}</label>
          <input className="ui-input" type="text" value={(value*100).toFixed(2)} onChange={handle} placeholder="%"/>
        </div>
      );
    }
    function Checkbox({label, checked, onChange}) {
      return (
        <label className="flex items-center gap-2 select-none">
          <input type="checkbox" className="scale-110 accent-[var(--c-primary)]" checked={checked} onChange={e=>onChange(e.target.checked)} />
          <span className="ui-sub">{label}</span>
        </label>
      );
    }

    // ————— Core monthly engine —————
    /**
     * Returns 36 months of results with:
     * - meetings schedule per month (custom or constant)
     * - wins → PMs added
     * - churn & expansion applied to active PM base
     * - revenue, GP, NP, jobs
     * Also returns Year 1 / Year 2 / Year 3 slices with
     * yearly-cumulative (reset each Jan) and rolling cumulative.
     */
    function useEngine(state){
      const {
        // targets & pricing
        netMargin, gpPct, revenuePerPM,
        // sales funnel
        closeRate, pmsPerAgency,
        // ops
        revenuePerApprovedJob, approval,
        // staffing capacity
        dispatcherCapacityYear, tlPerDispatchers, omPerTls, amPerPM,
        // schedule
        useCustomSchedule, schedule, meetingsPerMonth,
        // churn & expansion
        monthlyChurn, monthlyExpansion
      } = state;

      return useMemo(()=>{
        const months36 = Array.from({length:36}, (_,i)=>i); // 0..35
        const meetings = months36.map((i)=>{
          if(!useCustomSchedule) return meetingsPerMonth;
          // repeat the 12-month plan over 36 months
          return schedule[i % 12] ?? meetingsPerMonth;
        });

        // cohort adds (PMs) each month from meetings
        const addsPM = months36.map(i => meetings[i] * closeRate * pmsPerAgency);

        // rolling active PM base with churn (removal) and adds; expansion affects revenue, not PM count
        const activePM = [];
        for(let m=0; m<36; m++){
          const prev = m===0 ? 0 : activePM[m-1];
          const churned = prev * monthlyChurn;
          activePM[m] = Math.max(0, prev - churned + addsPM[m]);
        }

        // revenue per active PM grows with monthly expansion (compounding)
        const rpmByMonth = months36.map(m => revenuePerPM * Math.pow(1+monthlyExpansion, m));

        // per-month revenue = active PM * revenue per PM (month-adjusted)
        const revenue = months36.map(m => activePM[m] * rpmByMonth[m] / 12); // convert annual per-PM to monthly flow
        const gp      = revenue.map(r => r * gpPct);
        const np      = gp.map(g => g * (netMargin / gpPct)); // keep Net Margin ratio to Revenue

        // Jobs math (for staffing)
        const jobsApproved = months36.map((m)=> revenue[m] / revenuePerApprovedJob);
        const jobsSent     = jobsApproved.map(v => v / approval);

        // rolling cumulative (never resets)
        const cumRevenue = revenue.map((_,i)=> revenue.slice(0,i+1).reduce((a,b)=>a+b,0));
        const cumNP      = np.map((_,i)=> np.slice(0,i+1).reduce((a,b)=>a+b,0));

        // yearly slices with reset of *totals* each year, but carrying PM base forward
        const sliceYear = (y)=>{ // y = 1,2,3
          const start = (y-1)*12;
          const end = y*12;
          const rows = [];
          let yrRevenue=0, yrNP=0;
          for(let i=start;i<end;i++){
            yrRevenue += revenue[i];
            yrNP += np[i];
            rows.push({
              t:`Y${y} M${i-start+1}`,
              m:i,
              monthName: months[i%12],
              addPM: addsPM[i],
              activePM: activePM[i],
              rev_month: revenue[i],
              gp: gp[i],
              np: np[i],
              jobsApproved: jobsApproved[i],
              jobsSent: jobsSent[i],
              cumRevenue: yrRevenue,
              cumNP: yrNP
            });
          }
          const yearRevenue = yrRevenue;
          const yearNP = yrNP;
          return {rows, yearRevenue, yearNP};
        };

        const Y1 = sliceYear(1);
        const Y2 = sliceYear(2);
        const Y3 = sliceYear(3);

        // staffing from *full-year* totals of Y1/Y2/Y3
        function staffingFrom(yearRows){
          const yearRev = yearRows.rows.reduce((a,r)=>a+r.rev_month,0);
          const yearApproved = yearRev / revenuePerApprovedJob;
          const yearSent = yearApproved / approval;
          const dispatchers = Math.max(1, Math.ceil(yearSent / dispatcherCapacityYear));
          const tls = Math.max(1, Math.ceil(dispatchers / tlPerDispatchers));
          const oms = Math.max(1, Math.ceil(tls / omPerTls));
          const ams = Math.max(1, Math.ceil((yearRows.rows.at(-1)?.activePM || 0) / amPerPM));
          return {dispatchers, tls, oms, ams, yearRev};
        }

        const staffY1 = staffingFrom(Y1);
        const staffY2 = staffingFrom(Y2);
        const staffY3 = staffingFrom(Y3);

        return {
          months36, meetings, addsPM, activePM, revenue, gp, np, jobsApproved, jobsSent,
          cumRevenue, cumNP, rpmByMonth,
          Y1, Y2, Y3,
          staffY1, staffY2, staffY3
        };
      }, [
        netMargin, gpPct, revenuePerPM, closeRate, pmsPerAgency, revenuePerApprovedJob, approval,
        dispatcherCapacityYear, tlPerDispatchers, omPerTls, amPerPM,
        useCustomSchedule, schedule, meetingsPerMonth, monthlyChurn, monthlyExpansion
      ]);
    }

    // ————— Main App —————
    function ExecutivesWarGame(){
      // core inputs (sane defaults)
      const [netMargin, setNetMargin] = useState(0.125);
      const [gpPct, setGpPct] = useState(0.275);
      const [revenuePerPM, setRevenuePerPM] = useState(40000); // ANNUAL per active PM

      const [closeRate, setCloseRate] = useState(0.90);
      const [pmsPerAgency, setPmsPerAgency] = useState(4);
      const [meetingsPerMonth, setMeetingsPerMonth] = useState(4);

      const [revenuePerApprovedJob, setRevenuePerApprovedJob] = useState(653.6);
      const [approval, setApproval] = useState(0.55);

      const [dispatcherCapacityYear, setDispatcherCapacityYear] = useState(1440);
      const [tlPerDispatchers, setTlPerDispatchers] = useState(4);
      const [omPerTls, setOmPerTls] = useState(4);
      const [amPerPM, setAmPerPM] = useState(30);

      const [useCustomSchedule, setUseCustomSchedule] = useState(true);
      const [schedule, setSchedule] = useState(Array(12).fill(4));

      const [monthlyChurn, setMonthlyChurn] = useState(0.08);     // 8% / mo
      const [monthlyExpansion, setMonthlyExpansion] = useState(0.01); // 1% / mo

      const [tab, setTab] = useState('dashboard');

      const engine = useEngine({
        netMargin, gpPct, revenuePerPM, closeRate, pmsPerAgency,
        revenuePerApprovedJob, approval,
        dispatcherCapacityYear, tlPerDispatchers, omPerTls, amPerPM,
        useCustomSchedule, schedule, meetingsPerMonth,
        monthlyChurn, monthlyExpansion
      });

      // quick calc tiles (Year 1)
      const y1Revenue = engine.Y1.yearRevenue;
      const y1NP = engine.Y1.yearNP;
      const y1GP = engine.Y1.rows.reduce((a,r)=>a+(r.rev_month*gpPct),0);

      const exportCSV = ()=>{
        const lines = [];
        lines.push("Month,Adds PM,Active PM,Revenue,GP,NP,Jobs Approved,Jobs Sent,Ytd Revenue,Ytd NP");
        engine.Y1.rows.forEach(r=>{
          lines.push([r.monthName, r.addPM, r.activePM, r.rev_month, r.rev_month*gpPct, r.np, r.jobsApproved, r.jobsSent, r.cumRevenue, r.cumNP].join(","));
        });
        const blob = new Blob([lines.join("\n")], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href=url; a.download='ClassAFix_ExecutivesWarGame_Y1.csv'; a.click();
        URL.revokeObjectURL(url);
      };

      const setScheduleMonth = (i, val)=>{
        setSchedule(prev => prev.map((v,idx)=> idx===i ? val : v));
      };

      // UI
      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between gap-3">
            <div>
              <div className="ui-title">Executives War Game — Class A Fix</div>
              <div className="ui-sub mt-1">Banker-grade, cohortized, rolling + yearly views</div>
            </div>
            <div className="flex items-center gap-2">
              <span className="badge badge-info">Internal</span>
              <button className="btn btn-primary" onClick={exportCSV}>Export Y1 CSV</button>
            </div>
          </div>

          {/* Controls */}
          <div className="ui-card p-4 md:p-5">
            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
              <PercentInput label="Net Margin %" value={netMargin} onChange={setNetMargin} />
              <PercentInput label="GP %" value={gpPct} onChange={setGpPct} />
              <NumberInput label="Revenue per PM (annual)" value={revenuePerPM} onChange={setRevenuePerPM} hint="Type any number (e.g., 23,750)" />
              <NumberInput label="Revenue / Approved Job" value={revenuePerApprovedJob} onChange={setRevenuePerApprovedJob} step={0.1} />

              <PercentInput label="Approval %" value={approval} onChange={setApproval} />
              <PercentInput label="Close Rate in Meeting" value={closeRate} onChange={setCloseRate} />
              <NumberInput label="PMs per Agency (avg)" value={pmsPerAgency} onChange={setPmsPerAgency} />
              <NumberInput label="Default Meetings / Month" value={meetingsPerMonth} onChange={setMeetingsPerMonth} />

              <NumberInput label="Dispatcher Capacity / Year" value={dispatcherCapacityYear} onChange={setDispatcherCapacityYear} />
              <NumberInput label="TLs per Dispatcher" value={tlPerDispatchers} onChange={setTlPerDispatchers} />
              <NumberInput label="OMs per TL" value={omPerTls} onChange={setOmPerTls} />
              <NumberInput label="AM Ratio (PMs per AM)" value={amPerPM} onChange={setAmPerPM} />

              <PercentInput label="Monthly Churn" value={monthlyChurn} onChange={setMonthlyChurn} />
              <PercentInput label="Monthly Expansion" value={monthlyExpansion} onChange={setMonthlyExpansion} />

              <div className="col-span-1 flex items-center gap-3">
                <Checkbox label="Use Custom Monthly Schedule" checked={useCustomSchedule} onChange={setUseCustomSchedule} />
                <span className={`badge ${useCustomSchedule?'badge-success':'badge-info'}`}>{useCustomSchedule?'Custom':'Default'}</span>
              </div>
            </div>
          </div>

          {/* KPI cards (Year 1) */}
          <div className="grid-cards">
            <div className="ui-card p-4">
              <div className="text-sm text-slate-500">Y1 Revenue</div>
              <div className="text-xl font-bold text-[var(--c-navy)]">{fmtMoney(y1Revenue)}</div>
            </div>
            <div className="ui-card p-4">
              <div className="text-sm text-slate-500">Y1 GP</div>
              <div className="text-xl font-bold">{fmtMoney(y1GP)}</div>
            </div>
            <div className="ui-card p-4">
              <div className="text-sm text-slate-500">Y1 NP</div>
              <div className="text-xl font-bold text-[var(--c-mint)]">{fmtMoney(y1NP)}</div>
            </div>
            <div className="ui-card p-4">
              <div className="text-sm text-slate-500">Active PM at Y1 end</div>
              <div className="text-xl font-bold">{fmtInt(engine.Y1.rows.at(-1)?.activePM || 0)}</div>
            </div>
          </div>

          {/* Tabs */}
          <div className="tabs">
            {['dashboard','schedule','cohorts','staffing'].map(id=>(
              <button key={id} className={`tab-btn ${tab===id?'active':''}`} onClick={()=>setTab(id)}>
                {id[0].toUpperCase()+id.slice(1)}
              </button>
            ))}
          </div>

          {/* Dashboard */}
          {tab==='dashboard' && (
            <div className="ui-card p-4 md:p-5 space-y-4">
              <div className="ui-sub">Cumulative NP (rolling, 36 months)</div>
              <div className="chart-h">
                <ResponsiveContainer>
                  <LineChart data={engine.months36.map((m)=>({ m, month:`M${m+1}`, cumNP: engine.cumNP[m], cumRevenue: engine.cumRevenue[m] }))}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="month" />
                    <YAxis />
                    <Tooltip />
                    <Legend />
                    <Line type="monotone" dataKey="cumNP" name="Cum NP" stroke="#42B77E" strokeWidth={2} dot={false}/>
                    <Line type="monotone" dataKey="cumRevenue" name="Cum Revenue" stroke="#1E3A8A" strokeWidth={2} dot={false}/>
                  </LineChart>
                </ResponsiveContainer>
              </div>

              <div className="ui-sub">Year 1 — Monthly Revenue</div>
              <div className="chart-h">
                <ResponsiveContainer>
                  <BarChart data={engine.Y1.rows.map((r,i)=>({ name:r.monthName, rev:r.rev_month }))}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="name" />
                    <YAxis />
                    <Tooltip />
                    <Legend />
                    <Bar dataKey="rev" name="Revenue" fill="#76CAE3" />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>
          )}

          {/* Meetings schedule */}
          {tab==='schedule' && (
            <div className="ui-card p-4 md:p-5 space-y-4">
              <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                {months.map((m, i)=> (
                  <div key={m}>
                    <label className="ui-label">{m} — Meetings</label>
                    <input className="ui-input" type="number" value={schedule[i]}
                      onChange={(e)=> setScheduleMonth(i, Number(e.target.value)||0)} />
                  </div>
                ))}
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="text-left text-slate-500">
                      <th className="py-2">Month</th>
                      <th>Adds PM</th>
                      <th>Active PM</th>
                      <th>Revenue</th>
                      <th>NP</th>
                      <th>Jobs Approved</th>
                      <th>Jobs Sent</th>
                      <th>YTD Revenue</th>
                      <th>YTD NP</th>
                    </tr>
                  </thead>
                  <tbody>
                    {engine.Y1.rows.map((r)=>(
                      <tr key={r.t} className="border-t">
                        <td className="py-2">{r.monthName}</td>
                        <td>{fmtInt(r.addPM)}</td>
                        <td>{fmtInt(r.activePM)}</td>
                        <td className="font-semibold">{fmtMoney(r.rev_month)}</td>
                        <td className="text-[var(--c-mint)] font-semibold">{fmtMoney(r.np)}</td>
                        <td>{fmtInt(r.jobsApproved)}</td>
                        <td>{fmtInt(r.jobsSent)}</td>
                        <td>{fmtMoney(r.cumRevenue)}</td>
                        <td>{fmtMoney(r.cumNP)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Cohorts (visualize churn + expansion) */}
          {tab==='cohorts' && (
            <div className="ui-card p-4 md:p-5 space-y-4">
              <div className="ui-sub">PM Retention by Cohort (adds in M1, M13, M25)</div>
              <div className="chart-h">
                <ResponsiveContainer>
                  <AreaChart data={Array.from({length:36},(_,i)=>({
                    m:i+1,
                    c1: i<12 ? engine.addsPM[0]*Math.pow(1-monthlyChurn, i) : 0,
                    c2: (i>=12 && i<24) ? engine.addsPM[12]*Math.pow(1-monthlyChurn, i-12) : 0,
                    c3: i>=24 ? engine.addsPM[24]*Math.pow(1-monthlyChurn, i-24) : 0
                  }))}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="m" />
                    <YAxis />
                    <Tooltip />
                    <Legend />
                    <Area dataKey="c1" name="Cohort Y1" type="monotone" stroke="#76CAE3" fill="#D9E7F1" />
                    <Area dataKey="c2" name="Cohort Y2" type="monotone" stroke="#1E3A8A" fill="#cfe0ff" />
                    <Area dataKey="c3" name="Cohort Y3" type="monotone" stroke="#FFB84D" fill="#ffe2b8" />
                  </AreaChart>
                </ResponsiveContainer>
              </div>
              <div className="ui-body text-slate-600">
                Cohorts show **additions** vs **leakage** (churn). Expansion increases revenue per PM, not PM count.
              </div>
            </div>
          )}

          {/* Staffing */}
          {tab==='staffing' && (
            <div className="ui-card p-4 md:p-5 space-y-4">
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                {[{y:'Year 1',s:engine.staffY1},{y:'Year 2',s:engine.staffY2},{y:'Year 3',s:engine.staffY3}].map(({y,s})=>(
                  <div key={y} className="p-4 border rounded-xl">
                    <div className="font-bold mb-2">{y}</div>
                    <div className="grid grid-cols-2 gap-3 text-sm">
                      <div>Dispatchers</div><div className="font-bold">{fmtInt(s.dispatchers)}</div>
                      <div>Team Leaders</div><div className="font-bold">{fmtInt(s.tls)}</div>
                      <div>Ops Managers</div><div className="font-bold">{fmtInt(s.oms)}</div>
                      <div>Account Managers</div><div className="font-bold">{fmtInt(s.ams)}</div>
                      <div>Revenue</div><div className="font-bold text-[var(--c-navy)]">{fmtMoney(s.yearRev)}</div>
                    </div>
                  </div>
                ))}
              </div>
              <div className="ui-body text-slate-500 pt-1">
                Yearly view **resets totals** each Jan, but **carries forward** the active PM base (rolling).
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<ExecutivesWarGame />);
  </script>
</body>
</html>
